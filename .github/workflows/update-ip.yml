name: Update IP List

on:
  schedule:
    - cron: '10 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  update-ip:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Create directories
        run: |
          mkdir -p ip data
          touch data/.gitkeep
          chmod 755 ip data
          echo "ç›®å½•ç»“æž„å·²åˆ›å»º:"
          tree -a ip data || ls -la ip data
          
      - name: Setup git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
      - name: Create merge script
        run: |
          cat > /tmp/merge_ips.py << 'EOF'
          import os
          import glob
          import subprocess
          
          def get_file_content(file_path):
              """èŽ·å–æ–‡ä»¶å†…å®¹,å¦‚æžœæ–‡ä»¶ä¸å­˜åœ¨è¿”å›žç©ºé›†åˆ"""
              try:
                  if os.path.exists(file_path):
                      with open(file_path) as f:
                          return set(line.strip() for line in f if line.strip())
                  return set()
              except Exception as e:
                  print(f"è¯»å–æ–‡ä»¶ {file_path} å¤±è´¥: {str(e)}")
                  return set()
          
          def get_conflict_content(file_path):
              """èŽ·å–å†²çªæ–‡ä»¶çš„ä¸¤ä¸ªç‰ˆæœ¬å†…å®¹"""
              try:
                  if not os.path.exists(file_path):
                      return set(), set()
                  
                  with open(file_path) as f:
                      content = f.read()
                  
                  # æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†²çªæ ‡è®°
                  if '<<<<<<< HEAD' not in content:
                      return get_file_content(file_path), set()
                  
                  # åˆ†å‰²å¹¶èŽ·å–ä¸¤ä¸ªç‰ˆæœ¬çš„å†…å®¹
                  parts = content.split('<<<<<<< HEAD\n', 1)[1]
                  ours, theirs = parts.split('=======\n', 1)
                  theirs = theirs.split('>>>>>>>', 1)[0]
                  
                  our_ips = set(line.strip() for line in ours.splitlines() if line.strip())
                  their_ips = set(line.strip() for line in theirs.splitlines() if line.strip())
                  
                  return our_ips, their_ips
              except Exception as e:
                  print(f"å¤„ç†å†²çªæ–‡ä»¶ {file_path} å¤±è´¥: {str(e)}")
                  return set(), set()
          
          def merge_ip_files(current_file, backup_file=None):
              """åˆå¹¶IPæ–‡ä»¶,å¤„ç†å†²çª"""
              try:
                  # èŽ·å–å½“å‰æ–‡ä»¶çš„ä¸¤ä¸ªç‰ˆæœ¬(å¦‚æžœæœ‰å†²çª)
                  current_ips, their_ips = get_conflict_content(current_file)
                  
                  # èŽ·å–å¤‡ä»½æ–‡ä»¶å†…å®¹(å¦‚æžœæœ‰)
                  backup_ips = get_file_content(backup_file) if backup_file else set()
                  
                  # åˆå¹¶æ‰€æœ‰ç‰ˆæœ¬çš„IP
                  merged = current_ips | their_ips | backup_ips
                  
                  # éªŒè¯IPæ ¼å¼
                  valid_ips = set()
                  for ip in merged:
                      parts = ip.split('#')
                      if len(parts) == 2 and ':' in parts[0]:
                          valid_ips.add(ip)
                  
                  # æŒ‰å›½å®¶ä»£ç åˆ†ç±»
                  by_country = {}
                  for ip in valid_ips:
                      country = ip.split('#')[1]
                      if country not in by_country:
                          by_country[country] = set()
                      by_country[country].add(ip)
                  
                  # åˆ›å»ºæˆ–æ›´æ–°å›½å®¶æ–‡ä»¶
                  for country, ips in by_country.items():
                      country_file = os.path.join('ip', f'{country.lower()}.txt')
                      with open(country_file, 'w') as f:
                          f.write('\n'.join(sorted(ips)))
                          f.write('\n')
                  
                  return True
              except Exception as e:
                  print(f"åˆå¹¶æ–‡ä»¶å¤±è´¥: {str(e)}")
                  return False
          
          # å¤„ç†æ‰€æœ‰IPæ–‡ä»¶
          success = True
          
          # èŽ·å–æ‰€æœ‰ç›¸å…³æ–‡ä»¶
          ip_files = set()
          ip_files.update(glob.glob('ip/*.txt'))
          if os.path.exists('/tmp/ip_backup'):
              ip_files.update(glob.glob('/tmp/ip_backup/*.txt'))
          
          # åˆå¹¶æ¯ä¸ªæ–‡ä»¶
          for ip_file in ip_files:
              base_name = os.path.basename(ip_file)
              current_file = os.path.join('ip', base_name)
              backup_file = os.path.join('/tmp/ip_backup', base_name)
              
              if not merge_ip_files(current_file, backup_file):
                  success = False
          
          exit(0 if success else 1)
          EOF
          
      - name: Run IP update script
        env:
          TARGET_DOMAIN: ${{ secrets.TARGET_DOMAIN }}
          TARGET_PORTS: ${{ secrets.TARGET_PORTS }}
          TARGET_URLS: ${{ secrets.TARGET_URLS }}
          FORCE_UPDATE: "true"
        run: |
          max_retries=3
          retry_count=0
          while [ $retry_count -lt $max_retries ]; do
            if python ip.py; then
              echo "IPæ›´æ–°æˆåŠŸ"
              break
            else
              echo "IPæ›´æ–°å¤±è´¥,æ­£åœ¨é‡è¯•($((retry_count+1))/$max_retries)"
              retry_count=$((retry_count+1))
              if [ $retry_count -eq $max_retries ]; then
                echo "::error::IPæ›´æ–°å¤±è´¥,å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                exit 1
              fi
              sleep 5
            fi
          done
          
      - name: Process changes
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            
            # ä¿å­˜å½“å‰æ›´æ”¹
            git stash
            
            # æ›´æ–°åˆ°æœ€æ–°ä»£ç 
            git fetch origin
            git reset --hard origin/main
            
            # å¤‡ä»½å½“å‰IPæ–‡ä»¶
            mkdir -p /tmp/ip_backup
            cp ip/*.txt /tmp/ip_backup/ 2>/dev/null || true
            
            # åº”ç”¨æœ¬åœ°æ›´æ”¹å¹¶å¤„ç†å†²çª
            if ! git stash pop; then
              echo "å­˜åœ¨å†²çª,å°è¯•è‡ªåŠ¨è§£å†³..."
              python /tmp/merge_ips.py
              
              if [ $? -ne 0 ]; then
                echo "IPåˆ—è¡¨åˆå¹¶å¤±è´¥"
                git rebase --abort
                exit 1
              fi
              
              # æ ‡è®°å†²çªå·²è§£å†³
              git add ip/
            else
              # æ²¡æœ‰å†²çª,æ­£å¸¸åˆå¹¶
              python /tmp/merge_ips.py
              
              if [ $? -ne 0 ]; then
                echo "IPåˆ—è¡¨åˆå¹¶å¤±è´¥"
                exit 1
              fi
              
              git add ip/
            fi
            
            git add data/ || true
            
            # æäº¤æ›´æ”¹
            hour=$(TZ='Asia/Shanghai' date +%H)
            if [ "$hour" = "10" ]; then
              git commit -m "Update IP List and GeoIP Database ($(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S'))"
            else
              git commit -m "Update IP List ($(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S'))"
            fi
            
            # æŽ¨é€æ›´æ”¹
            max_retries=3
            retry_count=0
            while [ $retry_count -lt $max_retries ]; do
              if git push origin main; then
                echo "æŽ¨é€æˆåŠŸ"
                break
              else
                echo "æŽ¨é€å¤±è´¥,æ­£åœ¨é‡è¯•($((retry_count+1))/$max_retries)"
                retry_count=$((retry_count+1))
                if [ $retry_count -eq $max_retries ]; then
                  echo "::error::æŽ¨é€å¤±è´¥,å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                  exit 1
                fi
                
                # é‡æ–°æ‹‰å–å¹¶åˆå¹¶
                git fetch origin
                git reset --hard origin/main
                python /tmp/merge_ips.py
                
                if [ $? -ne 0 ]; then
                  echo "IPåˆ—è¡¨åˆå¹¶å¤±è´¥"
                  exit 1
                fi
                
                git add ip/
                if [ "$hour" = "10" ]; then
                  git commit -m "Update IP List and GeoIP Database ($(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S'))"
                else
                  git commit -m "Update IP List ($(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S'))"
                fi
                sleep 5
              fi
            done
          else
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          fi
          
      - name: Update Issue
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const time = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
            const status = process.env.hour === '10' ? 'âœ… IPåˆ—è¡¨å’ŒGeoIPæ•°æ®åº“å·²æ›´æ–°' : 'âœ… IPåˆ—è¡¨å·²æ›´æ–°';
            
            let ipStats = '';
            try {
              const fs = require('fs');
              const ipContent = fs.readFileSync('ip/ip.txt', 'utf8');
              const ips = ipContent.split('\n').filter(line => line.trim());
              const countries = {};
              ips.forEach(ip => {
                const country = ip.split('#')[1];
                countries[country] = (countries[country] || 0) + 1;
              });
              ipStats = Object.entries(countries)
                .map(([country, count]) => `${country}: ${count}ä¸ª`)
                .join('\n');
            } catch (e) {
              ipStats = 'æ— æ³•è¯»å–IPç»Ÿè®¡ä¿¡æ¯';
            }
            
            const issueBody = `
            ## IP List Update Status
            
            ðŸ•’ æ›´æ–°æ—¶é—´: ${time}
            
            ### æ›´æ–°çŠ¶æ€
            ${status}
            
            ### IPç»Ÿè®¡
            \`\`\`
            ${ipStats}
            \`\`\`
            
            ### æ–‡ä»¶çŠ¶æ€
            \`\`\`
            ${require('child_process').execSync('git status -s').toString()}
            \`\`\`
            
            ### ç›®å½•å†…å®¹
            IPç›®å½•:
            \`\`\`
            ${require('child_process').execSync('ls -l ip/').toString()}
            \`\`\`
            
            Dataç›®å½•:
            \`\`\`
            ${require('child_process').execSync('ls -l data/').toString()}
            \`\`\`
            
            ---
            ðŸ¤– æ­¤æ¶ˆæ¯ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ
            `;
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['status'],
              state: 'open'
            });
            
            if (issues.data.length > 0) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: issueBody
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'IP List Update Status',
                body: issueBody,
                labels: ['status']
              });
            }
