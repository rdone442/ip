name: Update IP List

on:
  schedule:
    - cron: '10 * * * *'    # æ¯å°æ—¶10åˆ†è¿è¡Œ 
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘
  
permissions:
  contents: write
  issues: write

jobs:
  update-ip:
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0     # èŽ·å–å®Œæ•´åŽ†å²ä»¥ä¾¿æ›´å¥½åœ°å¤„ç†å†²çª
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Create directories
        run: |
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p ip data
          
          # åªåœ¨dataç›®å½•ä¸‹åˆ›å»º.gitkeep
          touch data/.gitkeep
          
          # ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®
          chmod 755 ip data
          
          echo "ç›®å½•ç»“æž„å·²åˆ›å»º:"
          tree -a ip data || ls -la ip data
          
      - name: Fetch latest changes
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git fetch origin
          git reset --hard origin/main
          
      - name: Validate existing IPs
        run: |
          echo "=== Validating existing IPs ==="
          python -c '
          import socket
          import requests
          import time
          import sys
          
          def validate_ip(ip, port):
              try:
                  ip = ip.strip("[]")  # å¤„ç†IPv6åœ°å€
                  sock = socket.socket(socket.AF_INET if ":" not in ip else socket.AF_INET6)
                  sock.settimeout(5)
                  result = sock.connect_ex((ip, int(port)))
                  sock.close()
                  return result == 0
              except:
                  return False
          
          valid_ips = []
          with open("ip/ip.txt") as f:
              for line in f:
                  line = line.strip()
                  if not line:
                      continue
                  ip_port = line.split("#")[0]
                  ip, port = ip_port.rsplit(":", 1)
                  if validate_ip(ip, port):
                      valid_ips.append(line)
                  time.sleep(0.1)  # é¿å…è¯·æ±‚è¿‡å¿«
          
          with open("ip/ip.txt", "w") as f:
              f.write("\n".join(valid_ips) + "\n")
          '
          
      - name: Run IP update script
        id: update
        env:
          TARGET_DOMAIN: ${{ secrets.TARGET_DOMAIN }}
          TARGET_PORTS: ${{ secrets.TARGET_PORTS }}
          TARGET_URLS: ${{ secrets.TARGET_URLS }}
          FORCE_UPDATE: "true"
        run: |
          # æœ€å¤šé‡è¯•3æ¬¡
          max_retries=3
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if python ip.py; then
              echo "IPæ›´æ–°æˆåŠŸ"
              break
            else
              echo "IPæ›´æ–°å¤±è´¥,æ­£åœ¨é‡è¯•($((retry_count+1))/$max_retries)"
              retry_count=$((retry_count+1))
              if [ $retry_count -eq $max_retries ]; then
                echo "::error::IPæ›´æ–°å¤±è´¥,å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                exit 1
              fi
              sleep 5
            fi
          done
          
      - name: Merge changes
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            
            # å°è¯•è‡ªåŠ¨åˆå¹¶
            if ! git pull --rebase origin main; then
              echo "è‡ªåŠ¨åˆå¹¶å¤±è´¥,å°è¯•æ‰‹åŠ¨åˆå¹¶"
              
              # ä¿å­˜å½“å‰æ›´æ”¹
              git stash
              
              # æ›´æ–°åˆ°æœ€æ–°ä»£ç 
              git reset --hard origin/main
              
              # é‡æ–°åº”ç”¨æ›´æ”¹
              git stash pop
              
              # å¤„ç†ip.txtçš„åˆå¹¶
              python -c '
              def merge_ip_files(file1, file2):
                  # è¯»å–ä¸¤ä¸ªæ–‡ä»¶çš„IP
                  with open(file1) as f:
                      ips1 = set(line.strip() for line in f if line.strip())
                  with open(file2) as f:
                      ips2 = set(line.strip() for line in f if line.strip())
                  
                  # åˆå¹¶IPå¹¶æŽ’åº
                  merged = sorted(ips1 | ips2)
                  
                  # å†™å›žæ–‡ä»¶
                  with open(file1, "w") as f:
                      f.write("\n".join(merged) + "\n")
              
              merge_ip_files("ip/ip.txt", ".git/MERGE_HEAD:ip/ip.txt")
              '
            fi
            
            # æäº¤æ›´æ”¹
            git add ip/
            git add data/ || true
            
            # æ ¹æ®åŒ—äº¬æ—¶é—´å†³å®šæäº¤ä¿¡æ¯
            hour=$(TZ='Asia/Shanghai' date +%H)
            if [ "$hour" = "10" ]; then
              git commit -m "Update IP List and GeoIP Database ($(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S'))"
            else
              git commit -m "Update IP List ($(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S'))"
            fi
            
            # æŽ¨é€æ›´æ”¹,æœ€å¤šé‡è¯•3æ¬¡
            max_retries=3
            retry_count=0
            while [ $retry_count -lt $max_retries ]; do
              if git push origin main; then
                echo "æŽ¨é€æˆåŠŸ"
                break
              else
                echo "æŽ¨é€å¤±è´¥,æ­£åœ¨é‡è¯•($((retry_count+1))/$max_retries)"
                retry_count=$((retry_count+1))
                if [ $retry_count -eq $max_retries ]; then
                  echo "::error::æŽ¨é€å¤±è´¥,å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                  exit 1
                fi
                git pull --rebase
                sleep 5
              fi
            done
          else
            echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          fi
          
      - name: Update Issue
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const time = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
            const status = process.env.hour === '10' ? 'âœ… IPåˆ—è¡¨å’ŒGeoIPæ•°æ®åº“å·²æ›´æ–°' : 'âœ… IPåˆ—è¡¨å·²æ›´æ–°';
            
            // èŽ·å–IPç»Ÿè®¡ä¿¡æ¯
            const fs = require('fs');
            let ipStats = '';
            try {
              const ipContent = fs.readFileSync('ip/ip.txt', 'utf8');
              const ips = ipContent.split('\n').filter(line => line.trim());
              const countries = {};
              ips.forEach(ip => {
                const country = ip.split('#')[1];
                countries[country] = (countries[country] || 0) + 1;
              });
              ipStats = Object.entries(countries)
                .map(([country, count]) => `${country}: ${count}ä¸ª`)
                .join('\n');
            } catch (e) {
              ipStats = 'æ— æ³•è¯»å–IPç»Ÿè®¡ä¿¡æ¯';
            }
            
            const issueBody = `
            ## IP List Update Status
            
            ðŸ•’ æ›´æ–°æ—¶é—´: ${time}
            
            ### æ›´æ–°çŠ¶æ€
            ${status}
            
            ### IPç»Ÿè®¡
            \`\`\`
            ${ipStats}
            \`\`\`
            
            ### æ–‡ä»¶çŠ¶æ€
            \`\`\`
            ${require('child_process').execSync('git status -s').toString()}
            \`\`\`
            
            ### ç›®å½•å†…å®¹
            IPç›®å½•:
            \`\`\`
            ${require('child_process').execSync('ls -l ip/').toString()}
            \`\`\`
            
            Dataç›®å½•:
            \`\`\`
            ${require('child_process').execSync('ls -l data/').toString()}
            \`\`\`
            
            ---
            ðŸ¤– æ­¤æ¶ˆæ¯ç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ
            `;
            
            // æŸ¥æ‰¾çŠ¶æ€Issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['status'],
              state: 'open'
            });
            
            if (issues.data.length > 0) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: issueBody
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'IP List Update Status',
                body: issueBody,
                labels: ['status']
              });
            }
